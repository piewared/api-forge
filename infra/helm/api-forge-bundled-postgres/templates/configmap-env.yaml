apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Values.global.namePrefix }}-postgres-env
  namespace: {{ .Values.global.namespace }}
  labels:
    app.kubernetes.io/name: postgres
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: api-forge-bundled-postgres
data:
  {{- /* Read environment variables from copied .env file */ -}}
  {{- $envContent := .Files.Get "files/.env" }}
  {{- if not $envContent }}
  {{- fail "ERROR: files/.env not found. Run deployment to copy config files first." }}
  {{- end }}

  {{- /* Load all variables from .env */ -}}
  {{- range $line := splitList "\n" $envContent -}}
    {{- if and (ne (trim $line) "") (not (hasPrefix "#" (trim $line))) -}}
      {{- $parts := splitList "=" $line -}}
      {{- if ge (len $parts) 2 -}}
        {{- $key := index $parts 0 | trim -}}
        {{- $rawValue := slice $parts 1 | join "=" | trim -}}
        {{- /* Strip inline comments (everything after # with optional whitespace before it) */ -}}
        {{- $value := regexReplaceAll "\\s*#.*$" $rawValue "" | trim }}
  {{ $key }}: {{ $value | quote }}
      {{- end -}}
    {{- end -}}
  {{- end }}

  # Postgres-specific entrypoint defaults (override .env if needed)
  TZ: "UTC"
  SECRETS_SOURCE_DIR: "/run/secrets"
  SECRETS_TARGET_DIR: "/app/secrets"
  CREATE_ENV_VARS: "true"
  SKIP_USER_SWITCH: "false"
  CERTS_TARGET_DIR: "/etc/postgresql/ssl"
  CONTAINER_USER_UID: "postgres"
  CONTAINER_USER_GID: "postgres"
  POSTGRES_INITDB_ARGS: "--auth-host=scram-sha-256 --data-checksums"
  PGDATA: "/var/lib/postgresql/data/pgdata"
  POSTGRES_CONFIG_FILE: "/etc/postgresql/postgresql.conf"
  POSTGRES_HBA_FILE: "/etc/postgresql/pg_hba.conf"
  APP_SCHEMA: "app"
